import streamlit as st
import numpy as np 
import pandas as pd 

import tensorflow as tf

import matplotlib.pyplot as plt


from sklearn.model_selection import train_test_split

# Data normalization
from sklearn.preprocessing import StandardScaler
st.title("Intelligent malware analysis")
file = st.file_uploader("Choose a CSV file", type=["csv"])
data=pd.read_csv('model/Malware dataset.csv')
data['classification'] = data.classification.map({'benign':0, 'malware':1})
X = data.drop(["hash","classification",'vm_truncate_count','shared_vm','exec_vm','nvcsw','maj_flt','utime'],axis=1)
Y = data["classification"]
x_train,x_test,y_train,y_test=train_test_split(X,Y,test_size=0.2,random_state=1)
if file is not None:
    # Read the uploaded CSV file into a DataFrame
    df = pd.read_csv(file)
    df = df.sample(frac=1).reset_index(drop=True)
    # loaded_model = tf.keras.models.load_model('model/malwarenn_model.h5')
    loaded_model = tf.keras.models.load_model('model')
    d = df.drop(["hash","classification",'vm_truncate_count','shared_vm','exec_vm','nvcsw','maj_flt','utime'],axis=1) 
    scaler = StandardScaler()
    x_train = scaler.fit_transform(x_train)
    x_test = scaler.transform(x_test)        
    scaled_data=scaler.transform(d)
    st.write("Orginal data")
    st.write(d)
    st.write("Scaled data")
    st.write(scaled_data)
    predictions = loaded_model.predict(scaled_data)
    predicted_classes = np.argmax(predictions, axis=-1)
    pred=["Malware" if value == 1 else "Not malware" for value in predicted_classes]
    st.write(pred[0])
